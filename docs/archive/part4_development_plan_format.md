# Part 4: Development Plan Document Format

## Executive Summary

Proposes a **hybrid YAML+Markdown format** for development plans that is both human-readable and machine-parseable, enabling automated workflow orchestration while maintaining clarity for developers.

## 1. Current Format Limitations

**Current** (`Planning.md`):
```markdown
# Implementation Plan: MACD Strategy

> **Status**: DRAFT
> **Planning Level**: 4

## Analysis & Research

### Senior Backend Developer Analysis
...
```

**Problems**:
- Manual structure validation (regex-heavy parsing)
- Status tracking via text search
- Level derivation from task ID (fragile)
- No explicit parent linking

## 2. Proposed: Structured Plan Format

### 2.1 Template Structure

```yaml
---
# Machine-Readable Frontmatter
plan_metadata:
  task_id: "4.3.2"
  task_name: "MACD Strategy Bundle"
  planning_level: 4
  parent_plan: "file://./4_3_Market_Intelligence/4_3_Planning.md"
  status: "DRAFT"  # DRAFT | READY_FOR_REVIEW | APPROVED | REJECTED
  
context:
  phase: "Phase 5"
  service: "Market Intelligence"
  feature: "MACD Strategy"
  expert_set: "AlphaSquad"
  
tracking:
  created: "2026-01-23T14:00:00Z"
  updated: "2026-01-23T16:30:00Z"
  agents:
    - role: "Analyst"
      completed: true
    - role: "Planner"
      completed: false
  
validation:
  schema_version: "2.0"
  required_sections:
    - "Analysis & Research"
    - "Proposed Changes"
    - "Verification Plan"
---

# Implementation Plan: MACD Strategy Bundle

## Planning Context
**Task**: 4.3.2  
**Level**: 4 (Feature Plan)  
**Parent**: [Market Intelligence Service](./4_3_Planning.md)  
**Status**: **DRAFT**

## Analysis & Research

### Senior Backend Developer Analysis
[Content generated by Analyst agent...]

### Quant Developer Analysis
[Content generated by Analyst agent...]

## Proposed Changes
[Content generated by Planner agent...]

## Verification Plan
[Content generated by Planner agent...]
```

### 2.2 Benefits

✅ **Machine-Parseable**: YAML frontmatter = structured data  
✅ **Human-Readable**: Markdown body for narrative  
✅ **Versioned**: Schema version enables migration  
✅ **Traceable**: Explicit parent links  
✅ **Auditable**: Agent completion tracking  

## 3. Multi-Level Plan Hierarchy

### L1 (Inception)
```yaml
---
plan_metadata:
  task_id: "5"
  planning_level: 1
  parent_plan: null  # Top level
  scope: "Phase 5: Advanced Trading Features"
---
# Phase 5 Inception Plan
## Strategic Goals
...
## Service Breakdown
- [5.1] Order Management
- [5.2] Portfolio Tracking
- [5.3] Market Intelligence  ← Clickable link to L2 plan
```

### L2 (Architecture)
```yaml
---
plan_metadata:
  task_id: "5.3"
  planning_level: 2
  parent_plan: "file://../phase5_inception.md#5.3"
  scope: "Market Intelligence Service"
---
# Market Intelligence Architecture
## Service Contracts
...
## Feature Breakdown
- [5.3.1] Signal Library
- [5.3.2] Strategy Bundles  ← Link to L3 plan
```

### L3-L5: Similar structure with increasing detail

## 4. Schema Evolution

### Version 1.0 (Current - Implicit)
- Markdown-only
- Status in header comment
- Manual validation

### Version 2.0 (Proposed)
- YAML frontmatter
- Explicit parent links
- Agent tracking
- Schema validation

### Version 3.0 (Future)
- Dependency graphs
- Auto-generated task IDs
- Inline verification checkpoints

## 5. Automated Validation

```python
# workflow_core/validators/plan_validator.py

import yaml
from pathlib import Path

def validate_plan(plan_file: Path) -&gt; bool:
    content = plan_file.read_text()
    
    # Split frontmatter and body
    if not content.startswith('---'):
        raise ValidationError("Missing YAML frontmatter")
    
    parts = content.split('---', 2)
    frontmatter = yaml.safe_load(parts[1])
    body = parts[2]
    
    # Validate schema
    assert frontmatter['plan_metadata']['schema_version'] == '2.0'
    
    # Validate required sections
    required = frontmatter['validation']['required_sections']
    for section in required:
        if f"## {section}" not in body:
            raise ValidationError(f"Missing section: {section}")
    
    # Validate parent link exists
    if frontmatter['plan_metadata']['planning_level'] &gt; 1:
        parent = frontmatter['plan_metadata']['parent_plan']
        assert parent is not None
    
    return True
```

## 6. Workflow Integration

### 6.1 Template Rendering

```python
# workflow_core/engine/atoms/render_template.py

def render_plan_template(task_id, level, context):
    frontmatter = {
        'plan_metadata': {
            'task_id': task_id,
            'planning_level': level,
            'parent_plan': context.get('parent_link'),
            'status': 'DRAFT'
        },
        'context': context,
        'tracking': {
            'created': datetime.now().isoformat(),
            'agents': []
        },
        'validation': {
            'schema_version': '2.0',
            'required_sections': get_required_sections(level)
        }
    }
    
    template = load_jinja_template(f'plan_L{level}.j2')
    return template.render(
        frontmatter=yaml.dump(frontmatter),
        **context
    )
```

### 6.2 Status Tracking

```python
def update_plan_status(plan_file, new_status):
    content = plan_file.read_text()
    parts = content.split('---', 2)
    
    frontmatter = yaml.safe_load(parts[1])
    frontmatter['plan_metadata']['status'] = new_status
    frontmatter['tracking']['updated'] = datetime.now().isoformat()
    
    new_content = f"---\n{yaml.dump(frontmatter)}---{parts[2]}"
    plan_file.write_text(new_content)
```

## 7. Agent Integration Example

```yaml
---
plan_metadata:
  task_id: "4.3.2"
  status: "IN_PROGRESS"
  
tracking:
  agents:
    - role: "Analyst"
      agent_id: "analyst_001"
      started: "2026-01-23T14:00:00Z"
      completed: "2026-01-23T14:45:00Z"
      output_section: "Analysis & Research"
    - role: "Planner"
      agent_id: "planner_002"
      started: "2026-01-23T15:00:00Z"
      completed: null  # Still in progress
      output_section: "Proposed Changes"
---
```

## 8. Migration Strategy

### Phase 1: Dual Format Support
- New plans use YAML+Markdown
- Legacy plans continue as Markdown-only
- Parser handles both formats

### Phase 2: Automated Migration
```bash
$ flow_manager migrate plans --to-version 2.0

Migrating 47 plans to v2.0 format...
✓ 4_3_Planning.md
✓ 4_3_2_Planning.md
...
```

### Phase 3: Deprecate Legacy
- Enforce v2.0 for new plans
- Archive old format docs

## 9. Export Formats

### For AI Consumption (JSON)
```bash
$ flow_manager export 4.3.2 --format json &gt; plan.json
```

### For Human Review (PDF)
```bash
$ flow_manager export 4.3.2 --format pdf &gt; plan.pdf
```

### For Visualization (Mermaid)
```bash
$ flow_manager visualize 4.3.2 --hierarchy
```
Generates:
```mermaid
graph TD  
    A[5: Phase 5] --&gt; B[5.3: Market Intelligence]
    B --&gt; C[5.3.2: Strategy Bundles]
    C --&gt; D[5.3.2.1: MACD Implementation]
```

## 10. Recommended Tools

| Tool | Purpose |
|------|---------|
| **YAML Linter** | Validate frontmatter syntax |
| **JSON Schema** | Enforce metadata structure |
| **Pandoc** | Convert to PDF/HTML |
| **yq** | Query/modify YAML programmatically |

## Conclusion

The hybrid YAML+Markdown format provides:
- **Machine parsing** for workflow automation
- **Human readability** for developer clarity  
- **Backward compatibility** via dual-format support
- **Future-proof** extensibility via schema versioning

---

**Status**: ✅ Plan Format Defined  
**Next**: Part 5 - RAG System for Codebase Indexing
